name: Ejemplo de Workflow con PR Mergeado

on:
  workflow_dispatch:
    inputs:
      branchPr:
        description: 'PR'
        type: string
        required: true
      releaseType:
        description: 'Release type'
        required: true
        default: 'Weekly release name'
        type: choice
        options:
          - Weekly release
          - Emergency
      releaseName:
        description: 'Release name'
        type: string
        required: true
      rootCausePr:
        description: 'Root Cause PR'
        type: string
        required: true
      jiraTicket:
        description: 'Jira ticket'
        type: string
        required: true
      reason4Fix:
        description: 'Reason fix is critical'
        type: string
        required: true
jobs:

  check-pr-information:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Print Variables
        run: |
          echo "PR: $PR"
          echo "TYPE: $TYPE"
          echo "RELEASE_NAME: $RELEASE_NAME"
          echo "ROOT_CAUSE_PR: $ROOT_CAUSE_PR"
          echo "JIRA_TICKET: $JIRA_TICKET"
          echo "REASON_FIX: $REASON_FIX"
        env:
          PR: ${{ inputs.branchPr }}
          TYPE: ${{ inputs.releaseType }}
          RELEASE_NAME: ${{ inputs.releaseName }}
          ROOT_CAUSE_PR: ${{ inputs.rootCausePr }}
          JIRA_TICKET: ${{ inputs.jiraTicket }}
          REASON_FIX: ${{ inputs.reason4Fix }}
      - name: get the Pr's information
        run: |
          prJson="$(gh pr view ${{ inputs.branchPr }} --json author,mergeCommit,mergeable,mergedAt,number,title,url,id,labels)" 
          rootCauseJson="$(gh pr view ${{ inputs.rootCausePr }} --json author,mergeCommit,mergeable,mergedAt,number,title,url,id,labels)" 
          echo 'PR_JSON='$prJson >> $GITHUB_ENV
          echo 'PROOT_CAUSE_JSON='$rootCauseJson >> $GITHUB_ENV
          pwd
          echo "PR_JSON: $PR_JSON"
          echo "REASON_FIX: $REASON_FIX"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Verify release
        run: |
          git fetch --all
          # Obtain branches following the pattern '*release*'
          branch_list=$(git branch -r --list '*release*' --format "%(refname:lstrip=3)")
          echo "Branch List:"
          echo "$branch_list"
          # Find branch input name
          found=false
          while IFS= read -r branch; do
            if echo "$branch" | grep -q ${{ inputs.releaseName }}; then
              echo "Branch founded ${{ inputs.releaseName }}: $branch"
              found=true
            fi
          done <<< "$branch_list"
          
          # Verify if branch was founded
          if ! $found; then
            echo "Branch doesn't exist"
            exit 1
          fi
          if echo "$branch_list" | grep -q "^release/${{ inputs.releaseName }}$"; then
            echo "La rama '${{ inputs.releaseName }}' existe."
          else
            echo "Error: La rama '${{ inputs.releaseName }}' no existe."
            exit 1
          fi
          if [[ "${{inputs.releaseType}}" == *Emergency* ]]; then
            echo "Emergency fix"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: get Release information
        run: |
          releases="$(gh release list --limit 1 --json name,tagName)" 
          echo 'RELEASES='$releases >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Print Releases info
        run: |
          echo "$RELEASES" | jq '.[0]'
          
        
